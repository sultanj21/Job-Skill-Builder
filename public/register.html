app.post("/register", async (req, res) => {
try {
const {
firstName,
lastName,
birthday,
email,
occupation,
password,
street,
city,
state,
zip,
college,
certificate,
gradDate
} = req.body;

// Check if email exists
const { data: existing, error: existingErr } = await supabase
.from("users")
.select("id")
.eq("email", email)
.maybeSingle();

if (existingErr) {
console.error("Supabase existingErr:", existingErr);
return res.json({
success: false,
message: "Database error: " + (existingErr.message || "unknown")
});
}

if (existing) {
return res.json({ success: false, message: "Email already exists" });
}

const hashed = await bcrypt.hash(password, 10);

const { data: inserted, error: insertErr } = await supabase
.from("users")
.insert({
full_name: `${firstName} ${lastName}`,
email,
password: hashed,
birthday,
occupation,
street,
city,
state,
zip,
college,
certificate,
grad_date: gradDate
})
.select()
.single();

if (insertErr) {
console.error("Supabase insertErr:", insertErr);
return res.json({
success: false,
message: "Insert error: " + (insertErr.message || "unknown")
});
}

res.json({ success: true, message: "Account created", userId: inserted.id });
} catch (err) {
console.error("Register catch error:", err);
res.json({ success: false, message: "Server error: " + err.message });
}
});
