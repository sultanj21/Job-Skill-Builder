<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Pathway Dashboard</title>
    <link rel="stylesheet" href="style.css"/>
    <style>
        body{
            display:flex;
            min-height:100vh;
            margin:0;
            font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
        }
        .sidebar{
            width:230px;
            background:#0f172a;
            color:#f9fafb;
            padding:18px 16px;
            display:flex;
            flex-direction:column;
        }
        .brand{
            font-size:22px;
            font-weight:800;
            margin-bottom:20px;
        }
        .nav-item{
            padding:10px 12px;
            border-radius:8px;
            cursor:pointer;
            margin-bottom:4px;
            font-size:14px;
            display:flex;
            align-items:center;
            gap:8px;
            color:#e5e7eb;
        }
        .nav-item.active,
        .nav-item:hover{
            background:#1d283a;
            color:#fff;
        }
        .nav-footer{
            margin-top:auto;
            font-size:13px;
            color:#9ca3af;
        }
        .nav-footer button{
            width:100%;
            margin-top:8px;
            background:#ef4444;
            border:none;
            padding:8px 10px;
            border-radius:6px;
            color:#fff;
            cursor:pointer;
            font-size:13px;
        }

        .main{
            flex:1;
            background:#f3f4f6;
            padding:20px;
            overflow-y:auto;
        }

        .card{
            background:#fff;
            border-radius:16px;
            padding:20px 22px;
            box-shadow:0 10px 25px rgba(15,23,42,.08);
            margin-bottom:18px;
        }

        .section-title{
            font-size:20px;
            font-weight:700;
            margin:0 0 10px;
        }
        .muted{color:#6b7280;font-size:14px;}

        .personal-grid{
            display:grid;
            grid-template-columns: minmax(0,2.1fr) minmax(0,1fr);
            gap:20px;
            align-items:flex-start;
        }
        .personal-grid img{
            width:90px;height:90px;border-radius:999px;object-fit:cover;
            border:3px solid #4f46e5;
        }

        .kv-row{margin:4px 0;font-size:14px;}
        .kv-row b{color:#111827;margin-right:4px;}

        /* Resume list */
        #resumeList li{
            font-size:14px;
            margin:4px 0;
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
        }
        #resumeList a{text-decoration:none;color:#2563eb;word-break:break-all;}
        #resumeList span{font-size:11px;color:#6b7280;}

        .tab{
            display:none;
        }
        .tab.active{
            display:block;
        }

        textarea{
            width:100%;
            min-height:140px;
            resize:vertical;
            padding:10px 12px;
            border-radius:10px;
            border:1px solid #d1d5db;
            font-family:inherit;
            font-size:14px;
        }
        table{
            width:100%;
            border-collapse:collapse;
            font-size:13px;
            margin-top:8px;
        }
        th,td{
            padding:6px 8px;
            border-bottom:1px solid #e5e7eb;
            text-align:left;
        }
        th{background:#f9fafb;font-weight:600;font-size:12px;}
        .pill{font-size:11px;padding:2px 7px;border-radius:999px;background:#e5e7ff;color:#4338ca;}
        .tag{
            display:inline-block;
            background:#ecfeff;
            color:#0e7490;
            border-radius:999px;
            padding:3px 8px;
            font-size:11px;
            margin:2px 2px 0 0;
        }
    </style>
</head>
<body>
<!-- SIDEBAR -->
<div class="sidebar">
    <div class="brand">Pathway</div>
    <div class="nav-item active" data-target="tab-personal">üë§ Personal Info</div>
    <div class="nav-item" data-target="tab-resume">üìÑ Resume Upload</div>
    <div class="nav-item" data-target="tab-formatter">‚ú® AI Resume Formatter</div>
    <div class="nav-item" data-target="tab-jobs">üß≠ Job Tracker</div>
    <div class="nav-item" data-target="tab-interviews">üé§ Interviews</div>
    <div class="nav-item" data-target="tab-settings">‚öôÔ∏è Settings</div>

    <div class="nav-footer">
        Logged in as <span id="navEmail">...</span>
        <button id="logoutBtn">Log out</button>
    </div>
</div>

<!-- MAIN AREA -->
<div class="main">
    <!-- PERSONAL INFO TAB -->
    <div class="tab active" id="tab-personal">
        <div class="card">
            <h2 class="section-title">Your Personal Information</h2>
            <p class="muted">We pulled this from your registration details.</p>
            <div class="personal-grid">
                <div id="personalInfoText">
                    <!-- filled by JS -->
                </div>
                <div>
                    <img id="profilePic" src="https://via.placeholder.com/90" alt="Profile picture">
                    <form id="avatarForm" style="margin-top:8px;">
                        <input type="file" id="avatarInput" name="avatar" accept="image/*" />
                        <button type="submit" style="margin-top:6px;">Update Picture</button>
                        <div id="avatarMsg" class="muted"></div>
                    </form>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 class="section-title" style="font-size:18px;">College & Graduation</h3>
            <div id="collegeInfoText"></div>
        </div>
    </div>

    <!-- RESUME TAB -->
    <div class="tab" id="tab-resume">
        <div class="card">
            <h2 class="section-title">Resume Upload</h2>
            <p class="muted">Upload PDFs or Word documents. They‚Äôll be stored in your Supabase storage.</p>

            <form id="resumeForm" enctype="multipart/form-data" style="margin-top:6px;">
                <input type="file" id="resumeInput" name="resume" accept=".pdf,.doc,.docx,.txt"/>
                <button type="submit" style="margin-top:8px;">Upload Resume</button>
                <div id="resumeMsg" class="muted"></div>
            </form>
        </div>

        <div class="card">
            <h3 class="section-title" style="font-size:18px;">Your Resumes</h3>
            <ul id="resumeList"></ul>
        </div>
    </div>

    <!-- FORMATTER TAB -->
    <div class="tab" id="tab-formatter">
        <div class="card">
            <h2 class="section-title">AI Resume Formatter (Simple)</h2>
            <p class="muted">Paste raw bullets or text and we‚Äôll normalize them into a clean bullet list.</p>

            <div class="form-group">
                <label for="rawResume">Paste resume text</label>
                <textarea id="rawResume" placeholder="- did something
- did another thing"></textarea>
            </div>
            <button id="formatBtn">Format</button>
            <p id="formatMsg" class="muted"></p>

            <div style="margin-top:16px;">
                <label><b>Formatted output</b></label>
                <pre id="formattedResume" style="white-space:pre-wrap;background:#f9fafb;border-radius:10px;padding:10px 12px;font-size:13px;"></pre>
            </div>
        </div>
    </div>

    <!-- JOB TRACKER TAB -->
    <div class="tab" id="tab-jobs">
        <div class="card">
            <h2 class="section-title">Job Applications</h2>
            <p class="muted">Track the positions you‚Äôve applied to.</p>

            <form id="jobForm" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;">
                <div class="form-group">
                    <label for="jobTitle">Title</label>
                    <input id="jobTitle" type="text" placeholder="Software Engineer"/>
                </div>
                <div class="form-group">
                    <label for="jobCompany">Company</label>
                    <input id="jobCompany" type="text" placeholder="Company name"/>
                </div>
                <div class="form-group">
                    <label for="jobStatus">Status</label>
                    <select id="jobStatus">
                        <option value="Applied">Applied</option>
                        <option value="Phone Screen">Phone Screen</option>
                        <option value="Onsite">Onsite</option>
                        <option value="Offer">Offer</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="jobDate">Date</label>
                    <input id="jobDate" type="date"/>
                </div>
                <div style="align-self:end;">
                    <button type="submit">Add Job</button>
                </div>
            </form>
            <p id="jobMsg" class="muted"></p>
        </div>

        <div class="card">
            <h3 class="section-title" style="font-size:18px;">Job List</h3>
            <table id="jobsTable">
                <thead>
                <tr>
                    <th>Title</th>
                    <th>Company</th>
                    <th>Status</th>
                    <th>Date</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- INTERVIEWS TAB -->
    <div class="tab" id="tab-interviews">
        <div class="card">
            <h2 class="section-title">Interviews</h2>
            <p class="muted">Keep track of upcoming interviews and notes.</p>

            <form id="interviewForm" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;">
                <div class="form-group">
                    <label for="intCompany">Company</label>
                    <input id="intCompany" type="text" placeholder="Company"/>
                </div>
                <div class="form-group">
                    <label for="intRole">Role</label>
                    <input id="intRole" type="text" placeholder="Job role"/>
                </div>
                <div class="form-group">
                    <label for="intDate">Date</label>
                    <input id="intDate" type="date"/>
                </div>
                <div class="form-group">
                    <label for="intTime">Time</label>
                    <input id="intTime" type="time"/>
                </div>
                <div class="form-group" style="grid-column:1/-1;">
                    <label for="intNotes">Notes</label>
                    <input id="intNotes" type="text" placeholder="Zoom link, who you‚Äôre talking to, etc."/>
                </div>
                <div style="align-self:end;">
                    <button type="submit">Add Interview</button>
                </div>
            </form>
            <p id="intMsg" class="muted"></p>
        </div>

        <div class="card">
            <h3 class="section-title" style="font-size:18px;">Upcoming Interviews</h3>
            <table id="interviewsTable">
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Company</th>
                    <th>Role</th>
                    <th>Notes</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- SETTINGS TAB -->
    <div class="tab" id="tab-settings">
        <div class="card">
            <h2 class="section-title">Settings</h2>
            <p class="muted">Basic account info is read-only for now. Use registration for new accounts.</p>
            <div id="settingsInfo"></div>
        </div>
    </div>
</div>

<script>
    // ---------------- NAV TABS ----------------
    const navItems = document.querySelectorAll(".nav-item");
    const tabs = document.querySelectorAll(".tab");

    navItems.forEach(item => {
        item.addEventListener("click", () => {
            navItems.forEach(i => i.classList.remove("active"));
            item.classList.add("active");
            const target = item.getAttribute("data-target");
            tabs.forEach(t => t.classList.toggle("active", t.id === target));
        });
    });

    // ---------------- LOAD SESSION / USER ----------------
    async function loadSession() {
        try {
            const res = await fetch("/check-session");
            const data = await res.json();

            if (!data.loggedIn) {
                window.location.href = "/login.html";
                return;
            }

            const u = data.user || {};
            const fullName = u.fullName || `${u.firstName || ""} ${u.lastName || ""}`.trim() || "Not provided";

            document.getElementById("navEmail").textContent = u.email || "unknown";

            // Personal info block
            const personalHtml = `
        <div class="kv-row"><b>Name:</b> ${fullName}</div>
        <div class="kv-row"><b>Email:</b> ${u.email || "Not provided"}</div>
        <div class="kv-row"><b>Birthday:</b> ${u.birthday || "Not provided"}</div>
        <div class="kv-row"><b>Occupation:</b> ${u.occupation || "Not provided"}</div>

        <h4 style="margin-top:14px;margin-bottom:4px;">Address</h4>
        <div class="kv-row"><b>Street:</b> ${u.street || ""}</div>
        <div class="kv-row"><b>City:</b> ${u.city || ""}</div>
        <div class="kv-row"><b>State:</b> ${u.state || ""}</div>
        <div class="kv-row"><b>ZIP:</b> ${u.zip || ""}</div>
      `;
            document.getElementById("personalInfoText").innerHTML = personalHtml;

            const collegeHtml = `
        <div class="kv-row"><b>College:</b> ${u.college || "Not provided"}</div>
        <div class="kv-row"><b>Degree:</b> ${u.certificate || "Not provided"}</div>
        <div class="kv-row"><b>Graduation:</b> ${u.gradDate || "Not provided"}</div>
      `;
            document.getElementById("collegeInfoText").innerHTML = collegeHtml;

            if (u.profilePicPath) {
                document.getElementById("profilePic").src = u.profilePicPath;
            }

            // Settings view
            document.getElementById("settingsInfo").innerHTML = `
        <div class="kv-row"><b>User ID:</b> ${u.id || "(hidden)"}</div>
        <div class="kv-row"><b>Email:</b> ${u.email || ""}</div>
        <div class="kv-row"><b>Name:</b> ${fullName}</div>
      `;

            // Load the other data
            loadResumes();
            loadJobs();
            loadInterviews();
        } catch (err) {
            console.error("check-session failed:", err);
            window.location.href = "/login.html";
        }
    }

    // ---------------- LOGOUT ----------------
    document.getElementById("logoutBtn").addEventListener("click", async () => {
        try {
            await fetch("/logout");
        } catch (e) { }
        window.location.href = "/login.html";
    });

    // ---------------- PROFILE PIC UPLOAD ----------------
    document.getElementById("avatarForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const msg = document.getElementById("avatarMsg");
        const fileInput = document.getElementById("avatarInput");
        if (!fileInput.files.length) {
            msg.textContent = "Please pick a file first.";
            return;
        }
        msg.textContent = "Uploading...";
        try {
            const fd = new FormData();
            fd.append("avatar", fileInput.files[0]);
            const res = await fetch("/profile-picture", {
                method: "POST",
                body: fd
            });
            const data = await res.json();
            if (!data.success) {
                msg.textContent = data.message || "Upload failed";
                return;
            }
            document.getElementById("profilePic").src = data.path;
            msg.textContent = "‚úÖ Updated!";
        } catch (err) {
            console.error(err);
            msg.textContent = "Error uploading picture.";
        }
    });

    // ---------------- RESUME UPLOAD + LIST ----------------
    async function loadResumes() {
        const list = document.getElementById("resumeList");
        list.innerHTML = "<li class='muted'>Loading...</li>";
        try {
            const res = await fetch("/resumes");
            const data = await res.json();
            if (!data.success) {
                list.innerHTML = "<li class='muted'>Could not load resumes.</li>";
                return;
            }
            if (!data.files || data.files.length === 0) {
                list.innerHTML = "<li class='muted'>No resumes uploaded yet.</li>";
                return;
            }
            list.innerHTML = "";
            data.files.forEach(f => {
                const li = document.createElement("li");
                const date = f.createdAt ? new Date(f.createdAt).toLocaleString() : "";
                li.innerHTML = `<a href="${f.url}" target="_blank">${f.name}</a><span>${date}</span>`;
                list.appendChild(li);
            });
        } catch (err) {
            console.error("loadResumes error:", err);
            list.innerHTML = "<li class='muted'>Error loading resumes.</li>";
        }
    }

    document.getElementById("resumeForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const msg = document.getElementById("resumeMsg");
        const fileInput = document.getElementById("resumeInput");
        if (!fileInput.files.length) {
            msg.textContent = "Choose a file first.";
            return;
        }
        msg.textContent = "Uploading...";
        try {
            const fd = new FormData();
            fd.append("resume", fileInput.files[0]);
            const res = await fetch("/uploadResume", { method:"POST", body: fd });
            const data = await res.json();
            if (!data.success) {
                msg.textContent = data.message || "Upload failed.";
                return;
            }
            msg.textContent = "‚úÖ Uploaded!";
            fileInput.value = "";
            loadResumes();
        } catch (err) {
            console.error("upload resume error:", err);
            msg.textContent = "Error uploading resume.";
        }
    });

    // ---------------- FORMATTER ----------------
    document.getElementById("formatBtn").addEventListener("click", async () => {
        const raw = document.getElementById("rawResume").value;
        const msg = document.getElementById("formatMsg");
        msg.textContent = "Formatting...";
        try {
            const res = await fetch("/api/format-resume", {
                method: "POST",
                headers: { "Content-Type":"application/json" },
                body: JSON.stringify({ text: raw })
            });
            const data = await res.json();
            if (!data.success) {
                msg.textContent = data.message || "Could not format text.";
                return;
            }
            msg.textContent = "‚úÖ Done!";
            document.getElementById("formattedResume").textContent = data.formattedText;
        } catch (err) {
            console.error(err);
            msg.textContent = "Error calling formatter.";
        }
    });

    // ---------------- JOBS ----------------
    async function loadJobs() {
        const tbody = document.querySelector("#jobsTable tbody");
        tbody.innerHTML = "<tr><td colspan='4' class='muted'>Loading...</td></tr>";
        try {
            const res = await fetch("/api/jobs");
            const data = await res.json();
            if (!data.success) {
                tbody.innerHTML = "<tr><td colspan='4' class='muted'>Could not load jobs.</td></tr>";
                return;
            }
            const jobs = data.jobs || [];
            if (!jobs.length) {
                tbody.innerHTML = "<tr><td colspan='4' class='muted'>No jobs yet.</td></tr>";
                return;
            }
            tbody.innerHTML = "";
            jobs.forEach(j => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${j.title || ""}</td>
          <td>${j.company || ""}</td>
          <td><span class="pill">${j.status || ""}</span></td>
          <td>${j.date || ""}</td>
        `;
                tbody.appendChild(tr);
            });
        } catch (err) {
            console.error("loadJobs error:", err);
            tbody.innerHTML = "<tr><td colspan='4' class='muted'>Error loading jobs.</td></tr>";
        }
    }

    document.getElementById("jobForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const job = {
            title: document.getElementById("jobTitle").value.trim(),
            company: document.getElementById("jobCompany").value.trim(),
            status: document.getElementById("jobStatus").value,
            date: document.getElementById("jobDate").value || null
        };
        const msg = document.getElementById("jobMsg");
        msg.textContent = "Saving...";
        try {
            const res = await fetch("/api/jobs", {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body: JSON.stringify(job)
            });
            const data = await res.json();
            if (!data.success) {
                msg.textContent = data.message || "Could not add job.";
                return;
            }
            msg.textContent = "‚úÖ Added!";
            e.target.reset();
            loadJobs();
        } catch (err) {
            console.error("add job error:", err);
            msg.textContent = "Error adding job.";
        }
    });

    // ---------------- INTERVIEWS ----------------
    async function loadInterviews() {
        const tbody = document.querySelector("#interviewsTable tbody");
        tbody.innerHTML = "<tr><td colspan='5' class='muted'>Loading...</td></tr>";
        try {
            const res = await fetch("/api/interviews");
            const data = await res.json();
            if (!data.success) {
                tbody.innerHTML = "<tr><td colspan='5' class='muted'>Could not load interviews.</td></tr>";
                return;
            }
            const list = data.interviews || [];
            if (!list.length) {
                tbody.innerHTML = "<tr><td colspan='5' class='muted'>No interviews yet.</td></tr>";
                return;
            }
            tbody.innerHTML = "";
            list.forEach(i => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${i.date || ""}</td>
          <td>${i.time || ""}</td>
          <td>${i.company || ""}</td>
          <td>${i.role || ""}</td>
          <td>${i.notes || ""}</td>
        `;
                tbody.appendChild(tr);
            });
        } catch (err) {
            console.error("loadInterviews error:", err);
            tbody.innerHTML = "<tr><td colspan='5' class='muted'>Error loading interviews.</td></tr>";
        }
    }

    document.getElementById("interviewForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const payload = {
            company: document.getElementById("intCompany").value.trim(),
            role: document.getElementById("intRole").value.trim(),
            date: document.getElementById("intDate").value || null,
            time: document.getElementById("intTime").value || null,
            notes: document.getElementById("intNotes").value.trim() || null
        };
        const msg = document.getElementById("intMsg");
        msg.textContent = "Saving...";
        try {
            const res = await fetch("/api/interviews", {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!data.success) {
                msg.textContent = data.message || "Could not add interview.";
                return;
            }
            msg.textContent = "‚úÖ Added!";
            e.target.reset();
            loadInterviews();
        } catch (err) {
            console.error("add interview error:", err);
            msg.textContent = "Error adding interview.";
        }
    });

    // ---------------- INIT ----------------
    loadSession();
</script>
</body>
</html>
